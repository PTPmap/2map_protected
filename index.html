<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Закрытая карта PTP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 80%; display: none; }
    #form, .export-btns { padding: 10px; display: none; flex-direction: column; gap: 6px; }
    #loginPanel { padding: 10px; display: flex; flex-direction: column; gap: 6px; }
    textarea, input, button { padding: 6px; width: 100%; }
    button { cursor: pointer; }
  </style>
</head>
<body>

<div id="loginPanel">
  <h3>Авторизация</h3>
  <input id="login" placeholder="Логин" />
  <input id="password" type="password" placeholder="Пароль" />
  <button onclick="authenticate()">Войти</button>
  <p id="loginError" style="color: red;"></p>
</div>

<div id="form">
  <h3>Добавить зону (ввод точек построчно)</h3>
  <textarea id="coordsInput" rows="6" placeholder="Пример:
01 55.93889 37.81104
02 55.94294 37.81280
03 55.95019 37.80205
04 55.94233 37.79477
01 55.93889 37.81104"></textarea>
  <input id="dateInput" placeholder="Дата закладки (ДД.ММ.ГГГГ)" />
  <input id="personInput" placeholder="ФИО закладчика" />
  <button onclick="saveZone()">Сохранить зону</button>
</div>

<div class="export-btns">
  <button onclick="exportToCSV()">Экспорт в Excel (CSV)</button>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const USERS = {
    admin: { password: "admin123", role: "admin" },
    irina: { password: "dog123", role: "user" },
    guest: { password: "view", role: "readonly" }
  };

  let currentUser = null;

  function authenticate() {
    const login = document.getElementById("login").value;
    const pass = document.getElementById("password").value;
    if (!USERS[login] || USERS[login].password !== pass) {
      document.getElementById("loginError").innerText = "Неверный логин или пароль";
      return;
    }
    currentUser = { login, ...USERS[login] };
    document.getElementById("loginPanel").style.display = "none";
    if (currentUser.role !== "readonly") document.getElementById("form").style.display = "flex";
    document.querySelector(".export-btns").style.display = "flex";
    document.getElementById("map").style.display = "block";
    map.invalidateSize(); // важно для Leaflet после показа
    renderPolygons();
  }

  const firebaseConfig = {
    apiKey: "AIzaSyDLam50xuih0zUwVT-2GPxLfeCgkj7r-38",
    authDomain: "searchdogszones.firebaseapp.com",
    databaseURL: "https://searchdogszones-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "searchdogszones",
    storageBucket: "searchdogszones.appspot.com",
    messagingSenderId: "32308846124",
    appId: "1:32308846124:web:5ec012be586903e7547b89"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const polygonsRef = db.ref("zones");
  const drawnPolygons = {};

  const map = L.map('map').setView([55.94, 37.81], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  function parseCoords(text) {
    const lines = text.trim().split("\n");
    return lines.map(line => {
      const parts = line.trim().split(/\s+/);
      return [parseFloat(parts[1]), parseFloat(parts[2])];
    });
  }

  function saveZone() {
    if (currentUser.role === "readonly") return alert("Недостаточно прав");
    const raw = document.getElementById("coordsInput").value;
    const date = document.getElementById("dateInput").value;
    const person = document.getElementById("personInput").value;
    if (!raw || !date || !person) return alert("Заполните все поля.");
    const coords = parseCoords(raw);
    const id = Date.now();
    db.ref("zones/" + id).set({ coords, date, person, participants: [] });
    alert("Зона сохранена");
    document.getElementById("coordsInput").value = "";
    document.getElementById("dateInput").value = "";
    document.getElementById("personInput").value = "";
  }

  function renderPolygons() {
    polygonsRef.on("value", snapshot => {
      const data = snapshot.val();
      if (!data) return;
      for (const id in drawnPolygons) map.removeLayer(drawnPolygons[id]);
      for (const id in data) {
        const zone = data[id];
        const poly = L.polygon(zone.coords, { color: "red" }).addTo(map);
        let info = `<b>Закладчик:</b> ${zone.person}<br><b>Дата:</b> ${zone.date}`;
        if (zone.participants?.length) {
          info += "<br><b>Участники:</b><ul>";
          zone.participants.forEach(p => {
            info += `<li>${p.name} (${p.date})</li>`;
          });
          info += "</ul>";
        }
        if (currentUser.role !== "readonly") {
          info += `<button onclick="markSearched('${id}')">Я пошёл на эту зону</button>`;
        }
        if (currentUser.role === "admin") {
          info += `<button onclick="deletePolygon('${id}')">Удалить</button>`;
        }
        poly.bindPopup(info);
        drawnPolygons[id] = poly;
      }
    });
  }

  function markSearched(id) {
    if (currentUser.role === "readonly") return;
    const name = prompt("Ваше ФИО:");
    const date = prompt("Дата выхода (ДД.ММ.ГГГГ):");
    if (name && date) {
      const ref = db.ref("zones/" + id + "/participants");
      ref.once("value", snapshot => {
        const arr = snapshot.val() || [];
        arr.push({ name, date });
        ref.set(arr);
        alert("Добавлено в список участников");
      });
    }
  }

  function deletePolygon(id) {
    if (currentUser.role !== "admin") return alert("Нет доступа");
    if (confirm("Удалить эту зону?")) {
      db.ref("zones/" + id).remove();
      alert("Удалено");
    }
  }

  function exportToCSV() {
    polygonsRef.once("value", snapshot => {
      const data = snapshot.val();
      if (!data) return alert("Нет данных для экспорта.");
      let csv = "ID;Дата закладки;Закладчик;Координаты;Участники\n";
      for (const id in data) {
        const z = data[id];
        const coords = JSON.stringify(z.coords);
        const participants = z.participants?.map(p => `${p.name} (${p.date})`).join(", ") || "";
        csv += `${id};${z.date};${z.person};"${coords}";"${participants}"\n`;
      }
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "zones_export.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  }
</script>

</body>
</html>
