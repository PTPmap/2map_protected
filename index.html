<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Закрытая карта PTP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background:#f3f3f3; }
    .container { max-width: 1100px; margin: 12px auto; padding: 0 8px; }
    #map { height: 70vh; display: none; border: 1px solid #ccc; border-radius:4px; background:#fff; }
    #form, .export-btns { padding: 10px; display: none; flex-direction: column; gap: 6px; background: #fff; border-radius:4px; margin-bottom:8px; }
    #loginPanel { padding: 10px; display: flex; flex-direction: column; gap: 6px; background: #fff; border-radius:4px; margin-bottom:8px; }
    textarea, input, button, select { padding: 8px; width: 100%; box-sizing: border-box; font-size:14px; }
    textarea { font-family: monospace; white-space: pre; min-height:80px; }
    button { cursor: pointer; border-radius:4px; }
    .top-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    #logoutBtn { display:none; }
    .note { font-size:12px; color:#666; margin-top:6px; }
    /* modal */
    .modal-backdrop { position: fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; padding:16px; border-radius:8px; width:320px; box-shadow:0 8px 24px rgba(0,0,0,0.2); }
    .modal h4 { margin:0 0 8px 0; }
    .modal .row { margin-bottom:8px; }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginPanel">
      <h3>Авторизация</h3>
      <input id="login" placeholder="Логин (например admin)" />
      <input id="password" type="password" placeholder="Пароль" />
      <div class="top-controls">
        <button id="loginBtn">Войти</button>
        <button id="logoutBtn" onclick="logout()">Выйти</button>
      </div>
      <p id="loginError" style="color: red;"></p>
      <p class="note">Примечание: пароли хранятся в базе (не в коде). Если логин не проходит — проверь ключи в ветке <code>users</code> в Realtime Database.</p>
    </div>

    <div id="form">
      <h3>Добавить зону (ввод точек построчно)</h3>
      <textarea id="coordsInput" placeholder="Можно добавить заголовок сверху, например:
Границы района:
01 54.29053 56.19061
02 54.28605 56.17644
..."></textarea>
      <label>Дата закладки</label>
      <input id="dateInput" type="date" />
      <input id="personInput" placeholder="ФИО закладчика" />
      <button id="saveBtn">Сохранить зону</button>
    </div>

    <div class="export-btns">
      <button id="exportBtn">Экспорт в Excel (CSV)</button>
    </div>

    <div id="map"></div>
  </div>

  <!-- modal template (invisible by default) -->
  <div id="modalRoot" style="display:none"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================== CONFIG: вставь сюда свой firebaseConfig ================ */
/* === PUT YOUR FIREBASE CONFIG HERE === */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
/* ======================================================================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const usersRef = db.ref("users");
const polygonsRef = db.ref("zones");

// -------------------- Map init --------------------
const map = L.map('map').setView([55.94, 37.81], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

let currentUser = null;
const drawnPolygons = {};
const loginToKey = { irina: "user" }; // optional mapping if you prefer using 'irina' as login while DB key is 'user'

// -------------------- Helpers --------------------
function isoFromDMY(dmy) {
  if (!dmy) return null;
  const m = dmy.trim().match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{4})$/);
  if (!m) return null;
  const dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0'), yyyy = m[3];
  return `${yyyy}-${mm}-${dd}`;
}
function dmyFromIso(iso) {
  if (!iso) return "";
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return iso;
  return `${m[3]}.${m[2]}.${m[1]}`;
}
function todayIso() {
  return new Date().toISOString().slice(0,10);
}

// -------------------- Auth --------------------
function showUIForUser() {
  document.getElementById("loginPanel").style.display = "none";
  if (currentUser.role !== "readonly") document.getElementById("form").style.display = "flex";
  document.querySelector(".export-btns").style.display = "flex";
  document.getElementById("map").style.display = "block";
  document.getElementById("logoutBtn").style.display = "inline-block";
  setTimeout(()=> map.invalidateSize(), 200);
  renderPolygons();
}

function authenticate() {
  const loginInput = document.getElementById("login").value.trim();
  const pass = document.getElementById("password").value.trim();
  if (!loginInput || !pass) { document.getElementById("loginError").innerText = "Введите логин и пароль"; return; }
  document.getElementById("loginError").innerText = "";

  const tryKey = (key) => usersRef.child(key).once("value").then(snap => {
    const u = snap.val();
    if (!u) return null;
    return { key, user: u };
  });

  (async () => {
    let res = await tryKey(loginInput);
    if (!res && loginToKey[loginInput]) res = await tryKey(loginToKey[loginInput]);
    if (!res) {
      document.getElementById("loginError").innerText = "Неверный логин или пароль";
      return;
    }
    const userObj = res.user;
    if (userObj.password !== pass) {
      document.getElementById("loginError").innerText = "Неверный логин или пароль";
      return;
    }
    currentUser = { login: loginInput, key: res.key, role: userObj.role || "readonly" };
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
    showUIForUser();
  })().catch(err => {
    alert("Ошибка авторизации: " + err);
  });
}

document.getElementById("loginBtn").addEventListener("click", authenticate);

function logout() {
  localStorage.removeItem("currentUser");
  location.reload();
}

window.addEventListener("load", () => {
  const saved = localStorage.getItem("currentUser");
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      showUIForUser();
    } catch(e) {
      localStorage.removeItem("currentUser");
      document.getElementById("loginPanel").style.display = "block";
    }
  } else {
    document.getElementById("loginPanel").style.display = "block";
  }
});

// -------------------- Coords parser --------------------
function parseCoords(text) {
  if (!text) return [];
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const coords = [];
  const re = /(-?\d+\.\d+)\s+(-?\d+\.\d+)/;
  lines.forEach(line => {
    const m = line.match(re);
    if (m) {
      const lat = parseFloat(m[1]);
      const lng = parseFloat(m[2]);
      if (!Number.isNaN(lat) && !Number.isNaN(lng)) coords.push([lat, lng]);
    }
  });
  return coords;
}

// -------------------- Save zone --------------------
function saveZone() {
  if (!currentUser || currentUser.role === "readonly") return alert("Недостаточно прав");
  const raw = document.getElementById("coordsInput").value;
  const date = document.getElementById("dateInput").value; // ISO yyyy-mm-dd
  const person = document.getElementById("personInput").value.trim();
  if (!raw || !date || !person) return alert("Заполните все поля.");

  const coords = parseCoords(raw);
  if (!coords.length) return alert("Не распознаны координаты. Убедитесь, что строки содержат широту и долготу.");

  const id = Date.now().toString();
  const payload = {
    coords,
    date,
    person,
    participants: [],
    pendingDelete: false,
    takeoffDate: null,
    removeDate: null
  };
  polygonsRef.child(id).set(payload)
    .then(()=> {
      alert("Зона сохранена");
      document.getElementById("coordsInput").value = "";
      document.getElementById("dateInput").value = "";
      document.getElementById("personInput").value = "";
    })
    .catch(err=> alert("Ошибка сохранения: " + err));
}

document.getElementById("saveBtn").addEventListener("click", saveZone);

// -------------------- Modal for deletion dates --------------------
function openDeletionModal(id, currentTakeoff, currentRemove) {
  // create modal content
  const root = document.getElementById("modalRoot");
  root.innerHTML = "";
  root.style.display = "block";

  const backdrop = document.createElement("div");
  backdrop.className = "modal-backdrop";

  const modal = document.createElement("div");
  modal.className = "modal";
  modal.innerHTML = `
    <h4>Поставить зону на удаление</h4>
    <div class="row"><label>Дата снятия</label><input id="modalTakeoff" type="date" value="${currentTakeoff || ''}"></div>
    <div class="row"><label>Дата удаления</label><input id="modalRemove" type="date" value="${currentRemove || ''}"></div>
    <div class="actions">
      <button id="modalCancel">Отмена</button>
      <button id="modalConfirm">Подтвердить</button>
    </div>
  `;
  backdrop.appendChild(modal);
  root.appendChild(backdrop);

  document.getElementById("modalCancel").addEventListener("click", () => {
    root.style.display = "none";
    root.innerHTML = "";
  });

  document.getElementById("modalConfirm").addEventListener("click", () => {
    const takeoff = document.getElementById("modalTakeoff").value;
    const remove = document.getElementById("modalRemove").value;
    if (!takeoff || !remove) return alert("Укажите обе даты в календаре.");
    if (remove < takeoff) return alert("Дата удаления должна быть не ранее даты снятия.");
    polygonsRef.child(id).update({
      pendingDelete: true,
      takeoffDate: takeoff,
      removeDate: remove
    }).then(()=> {
      alert("Зона поставлена на удаление");
      root.style.display = "none";
      root.innerHTML = "";
    }).catch(err => alert("Ошибка: " + err));
  });
}

// -------------------- Delete controls --------------------
function deleteNow(id) {
  if (!currentUser || currentUser.role !== "admin") return alert("Нет доступа");
  if (!confirm("Удалить зону навсегда?")) return;
  polygonsRef.child(id).remove().catch(err=> alert("Ошибка удаления: "+err));
}

function markForDeletion(id) {
  if (!currentUser || currentUser.role !== "admin") return alert("Нет доступа");
  // fetch current values to prefill modal
  polygonsRef.child(id).once("value").then(snap => {
    const z = snap.val() || {};
    openDeletionModal(id, z.takeoffDate || "", z.removeDate || "");
  }).catch(err => alert("Ошибка: " + err));
}

// -------------------- Render polygons --------------------
function renderPolygons() {
  polygonsRef.on("value", snapshot => {
    const data = snapshot.val();
    // clear
    for (const id in drawnPolygons) {
      try { map.removeLayer(drawnPolygons[id]); } catch(e){}
    }
    Object.keys(drawnPolygons).forEach(k => delete drawnPolygons[k]);
    if (!data) return;

    for (const id in data) {
      const zone = data[id];
      const color = zone.pendingDelete ? "orange" : "red";
      const poly = L.polygon(zone.coords, { color }).addTo(map);

      let info = `<b>Закладчик:</b> ${zone.person || ""}<br><b>Дата закладки:</b> ${dmyFromIso(zone.date) || ""}`;
      if (zone.pendingDelete) {
        info += `<br><b style="color:orange">Помечено на удаление</b>`;
        if (zone.takeoffDate) info += `<br><b>Дата снятия:</b> ${dmyFromIso(zone.takeoffDate)}`;
        if (zone.removeDate) info += `<br><b>Дата удаления:</b> ${dmyFromIso(zone.removeDate)}`;
      }
      if (zone.participants?.length) {
        info += "<br><b>Участники:</b><ul>";
        zone.participants.forEach(p => { info += `<li>${p.name} (${p.date})</li>`; });
        info += "</ul>";
      }
      if (currentUser && currentUser.role === "admin") {
        info += `<br><button onclick="deleteNow('${id}')">Удалить навсегда</button>
                 <button onclick="markForDeletion('${id}')">Поставить на удаление</button>`;
      }

      poly.bindPopup(info);
      drawnPolygons[id] = poly;
    }

    const firstKey = Object.keys(data)[0];
    if (firstKey) {
      const first = data[firstKey];
      if (first && first.coords && first.coords.length) {
        map.fitBounds(first.coords, { padding: [20,20] });
      }
    }

    // check auto deletions right after rendering
    checkAutoDeletions();
  });
}

// -------------------- Auto-deletion --------------------
function checkAutoDeletions() {
  const today = todayIso();
  polygonsRef.once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) return;
    for (const id in data) {
      const z = data[id];
      if (z.pendingDelete && z.removeDate) {
        if (z.removeDate <= today) {
          polygonsRef.child(id).remove().catch(err => console.warn("Auto-delete error:", err));
        }
      }
    }
  }).catch(err => console.warn("checkAutoDeletions error:", err));
}
setInterval(checkAutoDeletions, 6 * 60 * 60 * 1000); // every 6 hours

// -------------------- Export --------------------
function exportToCSV() {
  polygonsRef.once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) return alert("Нет данных для экспорта.");
    let csv = "ID;Дата закладки;Закладчик;Координаты;Состояние;Дата снятия;Дата удаления;Участники\n";
    for (const id in data) {
      const z = data[id];
      const coords = JSON.stringify(z.coords);
      const state = z.pendingDelete ? "pending" : "active";
      const takeoff = z.takeoffDate || "";
      const remove = z.removeDate || "";
      const participants = (z.participants || []).map(p => `${p.name} (${p.date})`).join(", ");
      csv += `${id};${z.date || ""};${z.person || ""};"${coords}";${state};${takeoff};${remove};"${participants}"\n`;
    }
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "zones_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  }).catch(err => alert("Ошибка экспорта: " + err));
}
document.getElementById("exportBtn").addEventListener("click", exportToCSV);

// -------------------- End --------------------
</script>
</body>
</html>
